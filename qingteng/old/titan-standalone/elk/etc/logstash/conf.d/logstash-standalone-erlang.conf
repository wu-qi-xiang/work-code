input {

    ########################################
    # Erlang input
    ########################################
    file {
        type => "erlang"
        path => [
            "/data/standalone-logs/*/data/titan-logs/erlang/*/private/log/debug_logs/info_msg/info_msg_*",
            "/data/standalone-logs/*/data/titan-logs/erlang/*/private/log/debug_logs/error_msg/error_msg_*",
            "/data/standalone-logs/*/data/titan-logs/erlang/*/private/log/debug_logs/critical_msg/critical_msg_*",
            "/data/standalone-logs/*/data/titan-logs/erlang/*/private/log/debug_logs/event_msg/event_msg_*"
        ]
        exclude => ["*.siz", "*.idx"]
        sincedb_path => "/data/logstash/sincedb_standalone_erlang"
        #sincedb_path => "/dev/null"
        start_position => "beginning"
        max_open_files => 64
        close_older => 2
#        ignore_older => 86400
        codec => multiline {
            pattern => "^%{TIMESTAMP_ISO8601}"
            negate => true
            what => "previous"
        }
    }

}

filter {

    if [type] == "erlang" {
        ########################################
        # Erlang filter
        ########################################

        grok {
            break_on_match => false
            match => { "path" => "/data/standalone-logs/%{DATA:company}/data" }
            match => { "path" => "erlang/%{DATA:path1}/private" }
            match => { "message" => "%{TIMESTAMP_ISO8601:log_time} \[%{NOTSPACE:log_level}\] %{GREEDYDATA:log_body}" }

            # match agentid:
            overwrite => [ "agent_id", "comid" ]
            match => { "log_body" => "<<\"id\">> => <<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "agent:<<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "agent: <<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "agent = <<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "agentid: <<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "agentId: <<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "AgentId: <<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "AgentId = <<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "agent_id = <<\"%{BASE16NUM:agent_id}\">>" }
            match => { "log_body" => "<<\"agent_id\">> => <<\"%{BASE16NUM:agent_id}\">>" }
            # [auth]packet2 sh node relogin, AgentInfo: {<<"7446448700557df95f74">>,
            #                                            <<"514472ae208da73c">>,
            match => { "log_body" => "AgentInfo: \{<<\"%{BASE16NUM:comid}\">>%{DATA}<<\"%{BASE16NUM:agent_id}\">>" }

            # match comid:
            match => { "log_body" => "<<\"comid\">> => <<\"%{BASE16NUM:comid}\">>" }

            # match error_reason:
            # [conn]agent logout, agent: <<"f27b356de479b726">>, reason: {error,closed}
            # [login] init state error, agent:<<"514472ae208da73c">>, error: {'EXIT',
            match => { "log_body" => "reason: \{%{DATA:error_reason}\}" }

            # match comid, online_status
            # 2017-03-06 00:00:01 [event] [<0.24229.30>,notify_lib,39]:
            # (Call)Type: 100002, Data: #{<<"agent_id">> => <<"3cf1db496e34373e">>,
            #                             <<"comid">> => <<"7446448700557df95f74">>,
            #                             <<"status">> => 0,
            #                             <<"timestamp">> => 1488729601}
            match => { "log_body" => "<<\"comid\">> => <<\"%{BASE16NUM:comid}\">>%{DATA}<<\"status\">> => %{NUMBER:online_status:int}," }

            # match error_code, error_reason:
            # 2017-02-21 12:47:17 [critical] [<0.2071.0>,msgcache_server,362]:
            # AgentId: <<"80d4bf86cd01973c">>,
            # Send reply msg not dialog: {b2b_msg,16777216,25,<0.2071.0>,dh,
            #                                     #{<<"req_cb">> => undefined,
            #                                       <<"req_id">> => <<"R-319fd67d1d1eb88073e">>,
            #                                       <<"ret_code">> => -10001,
            #                                       <<"ret_msg">> => <<"{error,flash_inactive}">>},
            #                                     false,undefined},
            match => { "log_body" => "<<\"ret_code\">> => %{NUMBER:error_code}," }
            match => { "log_body" => "<<\"ret_msg\">> => <<\"%{DATA:error_reason}\">>" }
            match => { "log_body" => "RetMsg = <<\"%{DATA:error_reason}\">>" }

            # match agent_ver:
            match => { "log_body" => "<<\"agent_vsn\">> => <<\"%{DATA:agent_ver}\">>" }

            # match job init
            # job init, job_id:2408387, comid:<<"90489157289a7383e438">>, type:3, type_desc:"chk_srv", from:"0"
            match => { "log_body" => "job init, job_id:%{NUMBER:job_id:int}, comid:<<\"%{BASE16NUM:comid}\">>, type:%{NUMBER:job_type:int}, type_desc:\"%{DATA:job_desc}\", from:" }

            # match job
            # job finish, job_id:348, comid:<<"059f40aa9076e694f1a0">>, status:0, recv_num:1,  suc_num:1, start_time:<<"2017-03-20 16:55:52">>
            match => { "log_body" => "job finish, job_id:%{NUMBER:job_id:int}, comid:<<\"%{BASE16NUM:comid}\">>, status:%{NUMBER}, recv_num:%{NUMBER:job_recv_agents:int},  suc_num:%{NUMBER:job_suc_agents:int}, start_time:<<\"%{TIMESTAMP_ISO8601:job_start_time}\">>" }

            # match job error - all
            # job_erorr, job_id:349, comid:<<"059f40aa9076e694f1a0">>, error_code:-10002, reason:<<"agent offline">>, agent_list:[<<"8f7cb38915d35747">>]
            match => { "log_body" => "job_erorr, job_id:%{NUMBER:job_id:int}, comid:<<\"%{BASE16NUM:comid}\">>, error_code:%{NUMBER:error_code}, reason:<<\"%{DATA:error_reason}\">>, agent_list:\[<<%{DATA:agent_list}>>\]" }

            # match job error
            # job_id:2449638, agent_id:<<"cdc50994520a16db">>, comid:<<"68449356970827cdfa92">>, ret_code:-10001, ret_msg:<<"{error,flash_inactive}">>
            match => { "log_body" => "job_id:%{NUMBER:job_id:int}, agent_id:<<\"%{BASE16NUM:agent_id}\">>, comid:<<\"%{BASE16NUM:comid}\">>, ret_code:%{NUMBER:error_code}, ret_msg:<<\"%{DATA:error_reason}\">>" }

            tag_on_failure => [ ]
        }

        ########################################
        # Erlang type
        ########################################
        if [path1] =~ "servicer_1_" {
            mutate {
                replace => { "type" => "erlang_sh" }
                remove_field => [ "path1", "path2" ]
            }
        }
        if [path1] =~ "servicer_2_" {
            mutate {
                replace => { "type" => "erlang_dh" }
                remove_field => [ "path1", "path2" ]
            }
        }
        if [path1] =~ "servicer_3_" {
            mutate {
                replace => { "type" => "erlang_om" }
                remove_field => [ "path1", "path2" ]
            }
        }
        if [path1] =~ "servicer_4_" {
            mutate {
                replace => { "type" => "erlang_selector" }
                remove_field => [ "path1", "path2" ]
            }
        }
        if [path1] =~ "servicer_5_" {
            mutate {
                replace => { "type" => "erlang_vine" }
                remove_field => [ "path1", "path2" ]
            }
        }
        if [path1] =~ "servicer_6_" {
            mutate {
                replace => { "type" => "erlang_channel" }
                remove_field => [ "path1", "path2" ]
            }
        }

        date {
            match => [ "log_time" , "yy-MM-dd HH:mm:ss" ]
            timezone => "Asia/Shanghai"
            target => "@timestamp"
            tag_on_failure => [ ]
        }

        date {
            match => [ "job_start_time" , "yy-MM-dd HH:mm:ss" ]
            timezone => "Asia/Shanghai"
            target => "start_time"
            tag_on_failure => [ ]
        }

        mutate {
            remove_field => "log_time"
            remove_field => "job_start_time"
            remove_field => "@version"
            remove_field => "host"
        }

        fingerprint {
            method => "SHA1"
            key => "titan"
        }
    }
}

output {
    if [type] =~ "^erlang" and [path] =~ "^\/data\/standalone-logs" {
        elasticsearch {
            hosts => ["10.10.3.124:9200"]
            sniffing => false
            index => "%{company}-%{+YYYY.MM.dd}"
            document_id => "%{fingerprint}"
            user => "admin"
            password => "admin"
        }
        #stdout { codec => rubydebug }
    }
}
